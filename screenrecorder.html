<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Recording and Saving</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --button-bg: #2c2c2c;
            --button-hover: #3d3d3d;
            --accent-color: #007bff;
            --border-color: #333333;
            
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        video {
            margin-top: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            max-width: min(90%, 800px);
            background-color: #000000;
            display: none;
        }

        video.active {
            display: block;
        }

        button {
            padding: 8px 16px;
            font-size: 14px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background-color: var(--button-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        button:hover:not(:disabled) {
            background-color: var(--button-hover);
            transform: translateY(-1px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .recording {
            animation: pulse 2s infinite;
            background-color: #dc3545 !important;
            color: white;
        }

        .history-item-actions button{

            box-shadow: inset 3px -2px 5px rgb(0 0 0 / 35%);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        #timer {
            font-size: 24px;
            margin: 5px;
            font-family: monospace;
            color: var(--accent-color);
        }

        .controls {
            margin: 10px 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
            max-width: 600px;
        }

        .recording-indicator {
            display: none;
            color: #dc3545;
            margin: 10px;
            font-weight: bold;
            font-size: 14px;
            padding: 4px 8px;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 4px;
        }

        .recording-indicator.active {
            display: inline-block;
        }

        .screen-select {
            margin: 10px 0;
            display: none;
            width: 100%;
            max-width: 600px;
        }

        .screen-select.visible {
            display: block;
        }

        .screen-option {
            background-color: var(--button-bg);
            padding: 15px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 200px;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .screen-option small {
            display: block;
            margin-top: 8px;
            opacity: 0.8;
            font-size: 0.8em;
        }

        .screen-option:hover {
            background-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 26, 0.95);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .loading.visible {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border: 6px solid var(--border-color);
            border-top: 6px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading p {
            font-size: 1.2em;
            margin: 0;
            color: var(--text-color);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .video-controls {
            max-width: min(90%, 800px);
            display: none;
            align-items: center;
            gap: 10px;
            background: var(--button-bg);
            padding: 10px;
            border-radius: 8px;
        }

        .video-controls.active {
            display: flex;
            width: 100%;
        }

        #seekBar {
            flex-grow: 1;
            height: 5px;
            cursor: pointer;
        }

        #currentTime, #duration {
            font-family: monospace;
            min-width: 45px;
        }

        .settings {
            margin: 10px 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        select {
            padding: 6px 12px;
            border-radius: 4px;
            background: var(--button-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            font-size: 14px;
        }

        .file-size {
            margin: 5px 0;
            font-size: 0.9em;
            color: #888;
            padding: 4px 8px;
            background: var(--button-bg);
            border-radius: 4px;
            display: inline-block;
        }

        .save-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            box-sizing: border-box;
        }

        .save-dialog.active {
            display: block;
        }

        .save-dialog input {
            width: 100%;
            padding: 8px 12px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--button-bg);
            color: var(--text-color);
            font-size: 14px;
            box-sizing: border-box;
        }

        .save-dialog .buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .overlay.active {
            display: block;
        }

        .recording-history {
            margin-top: 20px;
            width: 100%;
            max-width: 800px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-item {
            background-color: var(--button-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .history-item-filename {
            font-weight: bold;
        }

        .history-item-details {
            font-size: 0.8em;
            color: #888;
            display: flex;
            gap: 15px;
        }

        .history-item-details span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .history-item-details svg {
            width: 14px;
            height: 14px;

        }

        .history-item-actions {
            display: flex;
            gap: 10px;
        }

        #playPauseBtn {
            background-color: var(--accent-color);
            padding: 12px;
            font-weight: bold;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        #playPauseBtn svg {
            width: 16px;
            height: 16px;
            fill: white;
            transition: all 0.2s ease;
        }

        #playPauseBtn.playing {
            background-color: #dc3545;
        }

        #playPauseBtn.playing:hover {
            background-color: #c82333;
        }

        #playPauseBtn:not(.playing) {
            background-color: #28a745;
        }

        #playPauseBtn:not(.playing):hover {
            background-color: #218838;
        }

        #playPauseBtn:hover {
            transform: scale(1.05);
        }

        #playPauseBtn:active {
            transform: scale(0.95);
        }

        .history-item-actions button {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .history-item-actions button:hover {
            transform: scale(1.1);
        }

        .history-item-actions button svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .history-item-actions .play-btn {
            color: #28a745;
        }

        .history-item-actions .play-btn:hover {
            background-color: rgba(40, 167, 69, 0.1);
        }

        .history-item-actions .delete-btn {
            color: #dc3545;
        }

        .history-item-actions .delete-btn:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }

        .recording-history {
            margin-top: 20px;
            width: 100%;
            max-width: 800px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            z-index: 9999;
            position: relative;
        }

        .history-header h2 {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-header h2::before {
            content: '▼';
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }

        .history-header.collapsed h2::before {
            transform: rotate(-90deg);
        }

        .history-list {
            transition: height 0.3s ease;
            overflow: hidden;
        }

        .history-list.collapsed {
            height: 0 !important;
        }

        .delete-all-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background-color: var(--button-bg);
            color: #dc3545;
            border: 1px solid #dc3545;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .delete-all-btn.visible {
            display: flex;
        }

        .delete-all-btn:hover {
            background-color: rgba(220, 53, 69, 0.1);
            transform: translateY(-1px);
        }

        .delete-all-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
        }

        .history-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
            padding: 0 15px;
        }

        .container {
            display: flex;
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            gap: 20px;
            padding: 20px;
            box-sizing: border-box;
            height: calc(100vh - 100px);
        }

        .recording-column {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            max-height: 100%;
            padding-right: 10px;
        }

        .playback-column {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            padding-right: 10px;
            gap: 20px;
            overflow-y: hidden;
        }

        .recording-history {
            margin-top: 0;
            width: 100%;
            overflow-y: auto;
            flex: 1;
        }

        #screenVideo {
            max-width: 100%;
        }

        #playbackVideo {
            max-width: 100%;
            display: none;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background-color: #000000;
            order: -1;
            flex-shrink: 0;
        }

        #playbackVideo.active {
            display: block;
        }

        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            .recording-column,
            .playback-column {
                width: 100%;
            }

            .playback-column {
                height: 100%;
                max-height: 100%;
                display: grid;
                grid-template-rows: auto auto 1fr;
                gap: 20px;
            }

            #playbackVideo {
                width: 100%;
                max-height: 40vh;
                order: -1;
            }

            .video-controls {
                width: 100%;
                order: -1;
            }

            .recording-history {
                overflow-y: auto;
                max-height: calc(60vh - 100px);
                min-height: 200px;
            }
        }

        /* Add this to ensure proper spacing in mobile view */
        @media (max-width: 1200px) {
            .container {
                height: auto;
                min-height: calc(100vh - 100px);
            }
        }

        .controls button {
            align-items: center;
            gap: 8px;
        }

        .controls button svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
           vertical-align: bottom;
        }

        .recording svg {
            animation: recordPulse 2s infinite;
        }

        @keyframes recordPulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .controls button#toggleVideo svg {
            display: none;
        }

        .controls button#toggleVideo svg.active {
            display: inline-block;
        }

        .recording-column::-webkit-scrollbar,
        .playback-column::-webkit-scrollbar {
            width: 8px;
        }

        .recording-column::-webkit-scrollbar-track,
        .playback-column::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        .recording-column::-webkit-scrollbar-thumb,
        .playback-column::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .recording-column::-webkit-scrollbar-thumb:hover,
        .playback-column::-webkit-scrollbar-thumb:hover {
            background: var(--button-hover);
        }

        body > h1 {
            margin: 20px;
            text-align: center;
        }

        .video-controls {
            order: -1;
            flex-shrink: 0;
        }

        .recording-history::-webkit-scrollbar {
            width: 8px;
        }

        .recording-history::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        .recording-history::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .recording-history::-webkit-scrollbar-thumb:hover {
            background: var(--button-hover);
        }

        .save-dialog .filename-container {
            display: flex;
            align-items: center;
            gap: 4px;
            margin: 10px 0;
            width: 100%;
            background: var(--button-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0 4px;
        }

        .save-dialog .filename-container input {
            flex: 1;
            border: none;
            background: none;
            margin: 0;
            padding: 8px;
        }

        .save-dialog .extension {
            color: var(--text-color);
            opacity: 0.7;
            padding: 8px 4px;
            user-select: none;
        }

        .history-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 15px;
            position: sticky;
            top: 0;
            background-color: var(--bg-color);
            z-index: 100;
        }

        .delete-all-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background-color: var(--button-bg);
            color: #dc3545;
            border: 1px solid #dc3545;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .delete-all-btn.visible {
            display: flex;
        }

        .history-header {
            cursor: pointer;
            user-select: none;
            z-index: 9999;
            position: relative;
        }

        .history-header h2 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .history-header.collapsed + .delete-all-btn {
            opacity: 0;
            pointer-events: none;
        }

        /* Add padding to the history list to prevent content from going under sticky header */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-top: 15px;
        }

    </style>
</head>
<body>
    <h1>Screen Recorder</h1>
    
    <div class="container">
         <div class="loading">
            <div class="spinner"></div>
            <p>Preparing recording. Please wait...</p>
        </div>
        <div class="recording-column">
            <div id="timer">00:00:00</div>
            <div class="recording-indicator">● Recording</div>
            <div id="fileSize" class="file-size">File size: 0 MB</div>

            <div class="screen-select">
                <h2>Select what to record:</h2>
                <div class="controls">
                    <button class="screen-option" data-type="screen" title="Record Entire Screen">
                        <div>Monitor Screen</div>
                        <small>Record your entire monitor display</small>
                    </button>
                    <button class="screen-option" data-type="window" title="Record Application Window">
                        <div>Application Window</div>
                        <small>Record a specific window</small>
                    </button>
                    <button class="screen-option" data-type="tab" title="Record Browser Tab">
                        <div>Browser Tab</div>
                        <small>Record current browser tab</small>
                    </button>
                </div>
            </div>

            <div class="controls">
                <button id="startCapture" title="Start Recording">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
                        <circle cx="12" cy="12" r="8" fill="currentColor"/>
                    </svg>
                </button>
                <button id="stopCapture" disabled title="Stop Recording">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-square"><rect x="3" y="3" width="18" height="18" rx="4" ry="4"></rect></svg>
                </button>
                <button id="toggleVideo" title="Hide Recording">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hide-icon">
                        <polygon points="23 7 16 12 23 17 23 7"></polygon>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="show-icon">
                        <path d="M16 16v1a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2m5.66 0H14a2 2 0 0 1 2 2v3.34l1 1L23 7v10"></path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>
                </button>
            </div>

            <div class="settings">
                <select id="qualitySelect">
                    <option value="high">High Quality (3 Mbps)</option>
                    <option value="medium">Medium Quality (1.5 Mbps)</option>
                    <option value="low">Low Quality (800 Kbps)</option>
                </select>
                <select id="formatSelect">
                    <option value="webm">WebM</option>
                    <option value="mp4">MP4</option>
                </select>
               
            </div>

            <video id="screenVideo" autoplay playsinline muted controlsList="nodownload"></video>
        </div>

        <div class="playback-column">
            <video id="playbackVideo" controlsList="nodownload"></video>
            <div class="video-controls">
                <button id="playPauseBtn">
                    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <input type="range" id="seekBar" value="0">
                <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
            </div>
            
            <div class="recording-history">
                <div class="history-top">
                    <div class="history-header">
                        <h2>Recording History</h2>
                    </div>
                    <button id="deleteAllBtn" class="delete-all-btn ${recordingHistory.length > 0 ? 'visible' : ''}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Delete All
                    </button>
                </div>
                <div id="historyList" class="history-list">
                    <!-- History items will be added here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <div class="overlay"></div>
    <div class="save-dialog">
        <h3>Save Recording</h3>
        <div class="filename-container">
            <input type="text" id="filename" placeholder="Enter filename">
            <span class="extension"></span>
        </div>
        <div class="buttons">
            <button id="cancelSave" title="Cancel Saving">Cancel</button>
            <button id="confirmSave" title="Confirm Save">Save</button>
        </div>
    </div>

    <script>
        const startButton = document.getElementById("startCapture");
        const stopButton = document.getElementById("stopCapture");
        const video = document.getElementById("screenVideo");
        const timerElement = document.getElementById("timer");
        const recordingIndicator = document.querySelector(".recording-indicator");
        const screenSelect = document.querySelector(".screen-select");
        const loading = document.querySelector(".loading");
        const fileSizeElement = document.getElementById('fileSize');
        const toggleVideoButton = document.getElementById("toggleVideo");
        let isVideoVisible = true;

        let captureStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let startTime = 0;
        let timerInterval = null;

        const qualitySelect = document.getElementById("qualitySelect");
        const formatSelect = document.getElementById("formatSelect");

        let recordingHistory = [];
        let db;

        let recordingDuration = 0;

        const initDB = () => {
            const request = indexedDB.open('ScreenRecorderDB', 1);
            
            request.onerror = (event) => {
                console.error('IndexedDB error:', event.target.error);
            };

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('recordings')) {
                    db.createObjectStore('recordings', { keyPath: 'id', autoIncrement: true });
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                loadRecordingHistory();
            };
        };

        function saveSettings() {
            const settings = {
                quality: qualitySelect.value,
                format: formatSelect.value,
                isVideoVisible: isVideoVisible
            };
            localStorage.setItem('screenRecorderSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('screenRecorderSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                
                // Apply saved settings
                qualitySelect.value = settings.quality || 'high';
                formatSelect.value = settings.format || 'webm';
                isVideoVisible = settings.isVideoVisible ?? true;
                
                // Update UI to match loaded settings
                const showIcon = toggleVideoButton.querySelector('.show-icon');
                const hideIcon = toggleVideoButton.querySelector('.hide-icon');
                
                if (isVideoVisible) {
                    showIcon.classList.remove('active');
                    hideIcon.classList.add('active');
                    toggleVideoButton.title = 'Hide Recording';
                } else {
                    showIcon.classList.add('active');
                    hideIcon.classList.remove('active');
                    toggleVideoButton.title = 'Show Recording';
                }
                
                if (video.srcObject) {
                    video.style.display = isVideoVisible ? "block" : "none";
                }
            }
        }

        qualitySelect.addEventListener('change', saveSettings);
        formatSelect.addEventListener('change', saveSettings);

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target === document.body) {
                e.preventDefault();
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    pauseRecording();
                }
            } else if (e.code === 'KeyR' && e.ctrlKey) {
                e.preventDefault();
                if (!mediaRecorder) {
                    startButton.click();
                }
            } else if (e.code === 'KeyS' && e.ctrlKey) {
                e.preventDefault();
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                }
            }
        });

        function updateTimer() {
            const elapsed = Date.now() - startTime;
            const seconds = Math.floor((elapsed / 1000) % 60);
            const minutes = Math.floor((elapsed / (1000 * 60)) % 60);
            const hours = Math.floor(elapsed / (1000 * 60 * 60));
            
            recordingDuration = elapsed / 1000;
            timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        async function startRecording(displayMediaOptions) {
            try {
                // Pause and hide any playing recording first
                const playbackVideo = document.getElementById('playbackVideo');
                if (playbackVideo) {
                    playbackVideo.pause();
                    playbackVideo.classList.remove('active');
                    playbackVideo.style.display = "none";
                    
                    // Hide video controls
                    const videoControls = document.querySelector('.video-controls');
                    videoControls.classList.remove('active');
                    
                    // Update play button state
                    updatePlayPauseButton(false);
                }

                loading.classList.add('visible');
                captureStream = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);
                
                video.srcObject = captureStream;
                video.style.display = isVideoVisible ? "block" : "none";
                video.classList.add('active');
                
                const quality = qualitySelect.value;
                const format = formatSelect.value;
                const mimeType = format === 'mp4' ? 'video/mp4' : 'video/webm;codecs=vp9';
                const bitrates = {
                    high: 3000000,
                    medium: 1500000,
                    low: 800000
                };

                mediaRecorder = new MediaRecorder(captureStream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: bitrates[quality]
                });
                
                recordedChunks = [];
                fileSizeElement.textContent = 'File size: 0 MB';

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                        const actualSize = recordedChunks.reduce((total, chunk) => total + chunk.size, 0) / (1024 * 1024);
                        fileSizeElement.textContent = `File size: ${actualSize.toFixed(1)} MB`;
                    }
                };

                mediaRecorder.onstop = () => {
                    const format = formatSelect.value;
                    const blob = new Blob(recordedChunks, { type: format === 'mp4' ? 'video/mp4' : 'video/webm' });
                    
                    const saveDialog = document.querySelector('.save-dialog');
                    const overlay = document.querySelector('.overlay');
                    const filenameInput = document.getElementById('filename');
                    const extensionSpan = document.querySelector('.extension');
                    
                    // Set the extension text
                    extensionSpan.textContent = format === 'mp4' ? '.mp4' : '.webm';
                    
                    // Get recording type for filename
                    const recordingType = displayMediaOptions.video.displaySurface || 'tab';
                    const recordingTypeNames = {
                        'monitor': 'Screen',
                        'window': 'Window',
                        'browser': 'Tab',
                        'tab': 'Tab'
                    };
                    
                    // Get date and time components
                    const now = new Date();
                    const date = now.toISOString().split('T')[0].replace(/-/g, ''); // YYYYMMDD
                    const time = now.toTimeString().split(' ')[0].replace(/:/g, ''); // HHMMSS
                    
                    // Calculate duration in seconds
                    const durationSecs = Math.round((Date.now() - startTime) / 1000);
                    const durationStr = durationSecs < 60 ? `${durationSecs}s` : `${Math.round(durationSecs/60)}m`;
                    
                    // Construct filename: Recording_Type_YYYYMMDD_HHMMSS_Duration
                    const defaultFilename = `Recording_${recordingTypeNames[recordingType]}_${date}_${time}_${durationStr}`;
                    
                    filenameInput.value = defaultFilename;
                    saveDialog.classList.add('active');
                    overlay.classList.add('active');
                    
                    const handleSave = () => {
                        let filename = filenameInput.value.trim();
                        if (filename) {
                            const extension = format === 'mp4' ? '.mp4' : '.webm';
                            if (!filename.toLowerCase().endsWith(extension)) {
                                filename += extension;
                            }
                            
                            const actualSize = recordedChunks.reduce((total, chunk) => total + chunk.size, 0) / (1024 * 1024);
                            
                            // Save to IndexedDB
                            const transaction = db.transaction(['recordings'], 'readwrite');
                            const store = transaction.objectStore('recordings');
                            
                            const recordingType = displayMediaOptions.video.displaySurface || 'tab';
                            
                            store.add({
                                filename: filename,
                                blob: blob,
                                timestamp: new Date().toISOString(),
                                size: actualSize.toFixed(1),
                                type: format === 'mp4' ? 'video/mp4' : 'video/webm',
                                recordingType: recordingType,
                                duration: recordingDuration
                            });

                            transaction.oncomplete = () => {
                                loadRecordingHistory();
                                
                                // Download the file
                                const a = document.createElement("a");
                                a.href = URL.createObjectURL(blob);
                                a.download = filename;
                                a.click();
                                URL.revokeObjectURL(a.href);
                            };
                        }
                        
                        cleanup();
                    };

                    const cleanup = () => {
                        saveDialog.classList.remove('active');
                        overlay.classList.remove('active');
                        
                        // Remove event listeners
                        document.getElementById('confirmSave').removeEventListener('click', handleSave);
                        document.getElementById('cancelSave').removeEventListener('click', cleanup);
                        filenameInput.removeEventListener('keyup', handleEnterKey);
                    };

                    const handleEnterKey = (e) => {
                        if (e.key === 'Enter') {
                            handleSave();
                        }
                    };

                    // Add event listeners
                    document.getElementById('confirmSave').addEventListener('click', handleSave);
                    document.getElementById('cancelSave').addEventListener('click', cleanup);
                    filenameInput.addEventListener('keyup', handleEnterKey);
                };

                mediaRecorder.start(1000);
                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000);
                
                startButton.disabled = true;
                stopButton.disabled = false;
                startButton.classList.add('recording');
                startButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
                        <circle cx="12" cy="12" r="8" fill="currentColor"/>
                    </svg>
                `;
                recordingIndicator.classList.add('active');
                screenSelect.classList.remove('visible');
                loading.classList.remove('visible');
            } catch (err) {
                console.error("Error starting screen recording:", err);
                alert("Failed to start recording: " + err.message);
                loading.classList.remove('visible');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
            }

            if (captureStream) {
                captureStream.getTracks().forEach(track => track.stop());
                captureStream = null;
                video.srcObject = null;
                video.style.display = "none";
                video.classList.remove('active');
            }

            // Store the final duration before clearing the timer
            const finalDuration = recordingDuration;
            
            clearInterval(timerInterval);
            timerElement.textContent = "00:00:00";
            startButton.disabled = false;
            stopButton.disabled = true;
            startButton.classList.remove('recording');
            startButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
                    <circle cx="12" cy="12" r="8" fill="currentColor"/>
                </svg>
                Start Recording
            `;
            recordingIndicator.classList.remove('active');
            
            // Reset recording duration
            recordingDuration = 0;
        }

        startButton.addEventListener("click", () => {
            // Hide any playing video and reset controls
            video.src = '';
            video.style.display = "none";
            video.classList.remove('active');
            document.querySelector('.video-controls').classList.remove('active');
            
            screenSelect.classList.add('visible');
        });

        document.querySelectorAll('.screen-option').forEach(button => {
            button.addEventListener('click', () => {
                const type = button.dataset.type;
                const displayMediaOptions = {
                    video: {
                        cursor: "always",
                        ...(type === 'screen' && {
                            displaySurface: "monitor",
                            logicalSurface: true
                        }),
                        ...(type === 'window' && {
                            displaySurface: "window"
                        }),
                        ...(type === 'tab' && {
                            displaySurface: "browser",
                            browserWindow: true
                        })
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    },
                    selfBrowserSurface: "include",
                    systemAudio: "include"
                };
                startRecording(displayMediaOptions);
            });
        });

        stopButton.addEventListener("click", stopRecording);

        toggleVideoButton.addEventListener("click", () => {
            isVideoVisible = !isVideoVisible;
            if (video.srcObject) {
                video.style.display = isVideoVisible ? "block" : "none";
            }
            
            const showIcon = toggleVideoButton.querySelector('.show-icon');
            const hideIcon = toggleVideoButton.querySelector('.hide-icon');
            
            if (isVideoVisible) {
                showIcon.classList.remove('active');
                hideIcon.classList.add('active');
                toggleVideoButton.title = 'Hide Recording';
            } else {
                showIcon.classList.add('active');
                hideIcon.classList.remove('active');
                toggleVideoButton.title = 'Show Recording';
            }
            
            saveSettings();
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            initDB();

            // Add delete all button event listener after DOM is loaded
            document.addEventListener('click', (e) => {
                if (e.target.closest('#deleteAllBtn')) {
                    if (recordingHistory.length === 0) {
                        alert('No recordings to delete.');
                        return;
                    }

                    if (confirm('Are you sure you want to delete all recordings? This action cannot be undone.')) {
                        const transaction = db.transaction(['recordings'], 'readwrite');
                        const store = transaction.objectStore('recordings');
                        const request = store.clear();

                        request.onsuccess = () => {
                            recordingHistory = [];
                            updateHistoryDisplay();
                        };

                        request.onerror = () => {
                            alert('Error deleting recordings.');
                        };
                    }
                }
            });
        });

        function loadRecordingHistory() {
            if (!db) return;

            const transaction = db.transaction(['recordings'], 'readonly');
            const store = transaction.objectStore('recordings');
            const request = store.getAll();

            request.onsuccess = () => {
                recordingHistory = request.result;
                updateHistoryDisplay();
            };
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            const currentHeight = historyList.scrollHeight;
            
            // Sort recordings by timestamp in descending order (newest first)
            recordingHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Update delete all button visibility
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            if (deleteAllBtn) {
                deleteAllBtn.classList.toggle('visible', recordingHistory.length > 0);
            }
            
            // Clear the history list
            historyList.innerHTML = '';
            
            historyList.style.height = currentHeight + 'px';

            recordingHistory.forEach((recording) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const date = new Date(recording.timestamp);
                const formattedDate = date.toLocaleString();
                
                const recordingTypeDisplay = {
                    'monitor': 'Full Screen',
                    'window': 'Application Window',
                    'browser': 'Browser Tab',
                    'tab': 'Browser Tab'
                }[recording.recordingType] || 'Screen Recording';
                
                // Get the appropriate icon based on recording type
                const recordingTypeIcon = {
                    'monitor': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>',
                    'window': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>',
                    'browser': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>',
                    'tab': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>'
                }[recording.recordingType] || '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>';
                
                historyItem.innerHTML = `
                    <div class="history-item-info">
                        <div class="history-item-filename">${recording.filename}</div>
                        <div class="history-item-details">
                            <span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                ${formattedDate}
                            </span>
                            <span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                ${recording.size} MB
                            </span>
                            <span>
                                ${recordingTypeIcon}
                                ${recordingTypeDisplay}
                            </span>
                        </div>
                    </div>
                    <div class="history-item-actions">
                        <button class="play-btn" onclick="playRecording(${recording.id})" title="Play Recording">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        </button>
                        <button class="delete-btn" onclick="deleteRecording(${recording.id})" title="Delete Recording">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });

            requestAnimationFrame(() => {
                historyList.style.height = historyList.scrollHeight + 'px';
            });
        }

        function playRecording(id) {
            const transaction = db.transaction(['recordings'], 'readonly');
            const store = transaction.objectStore('recordings');
            const request = store.get(id);

            request.onsuccess = () => {
                const recording = request.result;
                if (recording) {
                    const url = URL.createObjectURL(recording.blob);
                    const playbackVideo = document.getElementById('playbackVideo');
                    playbackVideo.src = url;
                    playbackVideo.style.display = "block";
                    playbackVideo.classList.add('active');
                    
                    // Store the duration as a data attribute
                    playbackVideo.dataset.storedDuration = recording.duration;
                    
                    // Make sure video controls are visible
                    const videoControls = document.querySelector('.video-controls');
                    videoControls.classList.add('active');
                    
                    setupVideoControls();
                    
                    // Initialize play button state and start playing
                    const playPauseBtn = document.getElementById('playPauseBtn');
                    updatePlayPauseButton(true);
                    
                    // Scroll the playback video into view smoothly
                    playbackVideo.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Autoplay the video
                    playbackVideo.play();
                    
                    playbackVideo.onended = () => {
                        URL.revokeObjectURL(url);
                    };
                }
            };
        }

        function deleteRecording(id) {
            if (confirm('Are you sure you want to delete this recording?')) {
                const transaction = db.transaction(['recordings'], 'readwrite');
                const store = transaction.objectStore('recordings');
                store.delete(id);
                
                transaction.oncomplete = () => {
                    loadRecordingHistory();
                };
            }
        }

        function setupVideoControls() {
            const playbackVideo = document.getElementById('playbackVideo');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const seekBar = document.getElementById('seekBar');
            const currentTime = document.getElementById('currentTime');
            const duration = document.getElementById('duration');
            const videoControls = document.querySelector('.video-controls');

            // Remove existing event listeners
            playPauseBtn.replaceWith(playPauseBtn.cloneNode(true));
            seekBar.replaceWith(seekBar.cloneNode(true));
            
            // Get the new elements after replacement
            const newPlayPauseBtn = document.getElementById('playPauseBtn');
            const newSeekBar = document.getElementById('seekBar');

            // Reset controls state
            videoControls.classList.add('active');
            newSeekBar.value = 0;
            currentTime.textContent = '0:00';
            duration.textContent = '0:00';

            // Add event listeners
            newPlayPauseBtn.addEventListener('click', () => {
                if (playbackVideo.paused) {
                    playbackVideo.play();
                    updatePlayPauseButton(true);
                } else {
                    playbackVideo.pause();
                    updatePlayPauseButton(false);
                }
            });

            playbackVideo.addEventListener('loadedmetadata', () => {
                if (!isFinite(playbackVideo.duration) && playbackVideo.dataset.storedDuration) {
                    newSeekBar.max = Math.floor(playbackVideo.dataset.storedDuration);
                    duration.textContent = formatTime(playbackVideo.dataset.storedDuration);
                } else if (isFinite(playbackVideo.duration)) {
                    newSeekBar.max = Math.floor(playbackVideo.duration);
                    duration.textContent = formatTime(playbackVideo.duration);
                }
            });

            // Update time display and seek bar position
            playbackVideo.addEventListener('timeupdate', () => {
                if (!newSeekBar.dragging) {
                    newSeekBar.value = Math.floor(playbackVideo.currentTime);
                    currentTime.textContent = formatTime(playbackVideo.currentTime);
                }
            });

            newSeekBar.addEventListener('input', () => {
                currentTime.textContent = formatTime(newSeekBar.value);
            });

            newSeekBar.addEventListener('mousedown', () => {
                newSeekBar.dragging = true;
            });

            newSeekBar.addEventListener('mouseup', () => {
                newSeekBar.dragging = false;
            });

            newSeekBar.addEventListener('change', () => {
                playbackVideo.currentTime = newSeekBar.value;
                newSeekBar.dragging = false;
            });

            playbackVideo.addEventListener('play', () => {
                updatePlayPauseButton(true);
            });

            playbackVideo.addEventListener('pause', () => {
                updatePlayPauseButton(false);
            });

            // Initial state
            updatePlayPauseButton(false);
        }

        function formatTime(seconds) {
            if (!isFinite(seconds)) return '0:00';
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function updatePlayPauseButton(isPlaying) {
            const playPauseBtn = document.getElementById('playPauseBtn');
            playPauseBtn.innerHTML = isPlaying ? 
                '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>' : 
                '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
            
            if (isPlaying) {
                playPauseBtn.classList.add('playing');
            } else {
                playPauseBtn.classList.remove('playing');
            }
        }

        const historyHeader = document.querySelector('.history-header');
        const historyList = document.getElementById('historyList');
        
        historyHeader.addEventListener('click', (e) => {
            if (e.target.closest('.delete-all-btn')) return;
            
            historyHeader.classList.toggle('collapsed');
            historyList.classList.toggle('collapsed');
            
            // Also toggle the delete all button visibility based on collapsed state
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            if (deleteAllBtn) {
                if (historyHeader.classList.contains('collapsed')) {
                    deleteAllBtn.style.opacity = '0';
                    deleteAllBtn.style.pointerEvents = 'none';
                } else {
                    deleteAllBtn.style.opacity = '1';
                    deleteAllBtn.style.pointerEvents = 'auto';
                }
            }
            
            if (!historyList.classList.contains('collapsed')) {
                historyList.style.height = historyList.scrollHeight + 'px';
            }
        });
    </script>
</body>
</html>
